let activeScrollLockOwner=null;const moviaStack=[];function getTopMovia(){return moviaStack[moviaStack.length-1]||null}function getTopScrollLockMovia(){for(let i=moviaStack.length-1;i>=0;i--){if(moviaStack[i].enableScrollLock){return moviaStack[i]}}return null}function updateScrollLock(){const newOwner=getTopScrollLockMovia();if(newOwner===activeScrollLockOwner)return;if(activeScrollLockOwner){activeScrollLockOwner._unlockScrollIfOwner()}if(newOwner){newOwner._activeScrollLockTarget=newOwner._resolveScrollLockTarget();newOwner._lockScroll()}activeScrollLockOwner=newOwner}const ALLOWED_KEYS=["defaultCloseMethods","defaultCssClass","destroyOnClose","autoSanitize","scrollLockTarget","enableScrollLock"];export const MoviaGlobal={defaultCloseMethods:["button","overlay","escape"],defaultCssClass:[],destroyOnClose:false,autoSanitize:true,scrollLockTarget:null,enableScrollLock:true,set(config={}){Object.keys(config).forEach(key=>{if(!ALLOWED_KEYS.includes(key)){console.warn(`[Movia] Invalid global config key: "${key}"`);return}this[key]=config[key]})}};let moviaIdCounter=0;export class Movia{templateId=null;content="";template=null;closeMethods=[];destroyOnClose=false;enableScrollLock=true;preserveScrollPosition=false;scrollLockTarget=null;footer=false;cssClass=[];footerButton=[];onOpen=null;onClose=null;constructor(config={}){const defaultConfig={templateId:null,content:"",closeMethods:MoviaGlobal.defaultCloseMethods.slice(),destroyOnClose:MoviaGlobal.destroyOnClose,cssClass:MoviaGlobal.defaultCssClass.slice(),enableScrollLock:MoviaGlobal.enableScrollLock,scrollLockTarget:null,footer:false,footerButton:[],onOpen:null,onClose:null,preserveScrollPosition:false};const finalConfig=Object.assign({},defaultConfig,config);Object.assign(this,finalConfig);if(!this.content&&!this.templateId){throw new Error("Movia requires either 'content' or 'templateId' to be provided.")}if(this.content&&this.templateId){this.content=null;console.warn("Both 'content' and 'templateId' are provided. 'templateId' will take precedence.")}if(this.templateId){const template=document.getElementById(this.templateId);if(!template){throw new Error(`[Movia] Template with id "${this.templateId}" does not exist.`)}this.template=template}else{this.template=null}this.id=++moviaIdCounter;this.isOpen=false;this.backdrop=null;this.footerElement=null;this.contentElement=null;this._childOpenHandler=null;this._isMounted=false;this._isDestroyed=false;this._pendingContent=null;this._pendingFooterButtons=[];this._pendingFooterContent=null;this._footerInitialized=false;this._keydownBound=false;this._keydownHandler=null;this._childMovias=[];this._parentMovia=null;this._isScrollLocked=false;this._activeScrollLockTarget=null;this._preScrollPaddingRight=null}createMovia(){if(this.backdrop)return this.backdrop;const backdrop=document.createElement("div");backdrop.className="movia";backdrop.id=`movia-${this.id}`;const container=document.createElement("div");container.className="movia__container";if(Array.isArray(this.cssClass)&&this.cssClass.length){this.cssClass.forEach(cls=>{if(typeof cls==="string"&&cls.trim()){container.classList.add(cls)}})}if(Array.isArray(this.closeMethods)&&this.closeMethods.includes("button")){const closeBtn=this._createButton("&times;","movia__close",this.close.bind(this));container.appendChild(closeBtn)}const moviaContent=document.createElement("div");moviaContent.className="movia__content";if(this.templateId){const template=document.getElementById(this.templateId);if(template&&template.content){moviaContent.appendChild(template.content.cloneNode(true))}else{moviaContent.innerHTML=String(this.content??"")}}else{moviaContent.innerHTML=String(this.content??"")}this.contentElement=moviaContent;container.append(moviaContent);if(Array.isArray(this.closeMethods)&&this.closeMethods.includes("overlay")){backdrop.addEventListener("click",e=>{if(e.target===backdrop)this.close()})}if(Array.isArray(this.closeMethods)&&this.closeMethods.includes("escape")){this._keydownHandler=e=>{if(e.key==="Escape"){const top=getTopMovia();if(top===this){this.close()}}}}if(this.footer){const moviaFooter=document.createElement("div");moviaFooter.className="movia__footer";this.footerElement=moviaFooter;this._renderFooter();container.appendChild(moviaFooter)}backdrop.append(container);this.backdrop=backdrop;return backdrop}updateContent(html){if(MoviaGlobal.autoSanitize){html=this.sanitizeHTML(html)}if(!this.backdrop){this._pendingContent=html;return}const contentEl=this.backdrop.querySelector(".movia__content");if(this.isOpen&&contentEl){contentEl.innerHTML=html}else{this._pendingContent=html}this.content=html}setFooterContent(html){if(MoviaGlobal.autoSanitize){html=this.sanitizeHTML(html)}if(!this.footerElement){this._pendingFooterContent=html;return}this.footerElement.innerHTML=html}sanitizeHTML(html){if(!MoviaGlobal.autoSanitize){return String(html??"")}const parser=new DOMParser;const doc=parser.parseFromString(String(html),"text/html");const dangerousTags=["script","iframe","embed","object","link","meta"];const dangerousAttrs=["onerror","onclick","onload","oninput","onchange","onmouseover"];dangerousTags.forEach(tag=>{doc.querySelectorAll(tag).forEach(el=>el.remove())});doc.querySelectorAll("*").forEach(el=>{[...el.attributes].forEach(attr=>{const name=attr.name.toLowerCase();const value=attr.value;if(name.startsWith("on")){el.removeAttribute(name);return}if(dangerousAttrs.includes(name)){el.removeAttribute(name);return}if((name==="href"||name==="src")&&value.trim().toLowerCase().startsWith("javascript:")){el.removeAttribute(name);return}})});return doc.body.innerHTML}renderLabel(input){if(input instanceof HTMLElement){return input.cloneNode(true)}if(typeof input==="function"){try{return this.renderLabel(input())}catch(err){return this._createSpan(String(err))}}if(typeof input!=="string"){return this._createSpan(String(input))}if(!/[<>]/.test(input)){return this._createSpan(input)}const span=document.createElement("span");span.innerHTML=this.sanitizeHTML(input);return span}_createSpan(text){const span=document.createElement("span");span.textContent=String(text);return span}_createButton(label,classNames="",onClick=null){const btn=document.createElement("button");btn.type="button";if(Array.isArray(classNames)){classNames.filter(Boolean).forEach(cls=>btn.classList.add(cls))}else if(typeof classNames==="string"&&classNames.trim()){classNames.split(/\s+/).forEach(cls=>btn.classList.add(cls))}if(typeof onClick==="function"){btn.addEventListener("click",e=>{onClick.call(this,e)})}if(typeof label==="string"&&/^&[a-zA-Z0-9]+;?$/.test(label)){btn.innerHTML=label}else{const rendered=this.renderLabel(label);if(rendered instanceof DocumentFragment){btn.appendChild(rendered)}else{btn.appendChild(rendered)}}return btn}addFooterButton(btnConfig={}){if(!btnConfig||typeof btnConfig!=="object")return;const exists=[...this.footerButton,...this._pendingFooterButtons].some(btn=>btn.label===btnConfig.label);if(exists)return;if(!this.footerElement){this._pendingFooterButtons.push(btnConfig);return}this.footerButton.push(btnConfig);this._renderFooter()}_renderFooter(){if(!this.footer||!this.footerElement)return;if(!this._footerInitialized){this.footerButton.push(...this._pendingFooterButtons);this._pendingFooterButtons=[];this._footerInitialized=true}this.footerElement.innerHTML="";if(this._pendingFooterContent!==null){this.footerElement.innerHTML=this._pendingFooterContent}this.footerButton.forEach(cfg=>{const btn=this._createButton(cfg.label,cfg.classNames,cfg.onClick);this.footerElement.appendChild(btn)})}setupChildMovia(childMovia){if(!childMovia)return;this._childMovias.push(childMovia);childMovia._parentMovia=this;if(this.isOpen&&this.backdrop){this._attachChildOpenHandler()}}_attachChildOpenHandler(){if(!this.backdrop)return;if(this._childOpenHandler)return;this._childOpenHandler=e=>{const btn=e.target.closest("[data-open-movia]");if(!btn)return;const openId=btn.dataset.openMovia??btn.getAttribute("data-open-movia");if(!openId)return;const child=this._childMovias.find(m=>openId===String(m.id)||openId===m.templateId);if(child){child.open()}};this.backdrop.addEventListener("click",this._childOpenHandler)}_resolveScrollLockTarget(){const input=this.scrollLockTarget??MoviaGlobal.scrollLockTarget??document.body;if(typeof input==="function"){return input()}if(typeof input==="string"){return document.querySelector(input)}if(input instanceof HTMLElement){return input}return document.body}_hasScrollbar(target){if(target===document.body||document.documentElement){const html=document.documentElement;const body=document.body;return html.scrollHeight>html.clientHeight||body.scrollHeight>body.clientHeight}return target.scrollHeight>target.clientHeight}_lockScroll(){if(this._isScrollLocked)return;const target=this._activeScrollLockTarget;if(!target)return;this._isScrollLocked=true;this._preScrollPaddingRight=window.getComputedStyle(target).paddingRight||"";const scrollbarWidth=this._hasScrollbar(target)?this._getScrollbarWidth():0;target.classList.add("movia--no-scroll");target.style.paddingRight=`${(parseFloat(this._preScrollPaddingRight)||0)+scrollbarWidth}px`}_unlockScrollIfOwner(){if(activeScrollLockOwner!==this)return;if(!this._isScrollLocked)return;const target=this._activeScrollLockTarget;if(!target)return;target.classList.remove("movia--no-scroll");target.style.paddingRight=this._preScrollPaddingRight;this._isScrollLocked=false;this._activeScrollLockTarget=null;this._preScrollPaddingRight=null}open(){if(this._isDestroyed){console.warn("Movia has been destroyed and cannot be reopened.");return}if(this.isOpen)return;this.isOpen=true;moviaStack.push(this);updateScrollLock();if(!this._isMounted){this.backdrop=this.createMovia();document.body.appendChild(this.backdrop);this._isMounted=true}if(this._childMovias.length){this._attachChildOpenHandler()}if(!document.body.contains(this.backdrop)){document.body.appendChild(this.backdrop)}if(this._pendingContent!==null){const contentEl=this.backdrop.querySelector(".movia__content");if(contentEl){contentEl.innerHTML=this._pendingContent}this._pendingContent=null}if(this._keydownHandler&&!this._keydownBound){document.addEventListener("keydown",this._keydownHandler);this._keydownBound=true}this.backdrop.style.visibility="";requestAnimationFrame(()=>{this.backdrop.classList.add("movia--show");this.backdrop.dispatchEvent(new CustomEvent("movia:ready"));this.onReady?.()});const backdrop=this.backdrop;this._onTransitionEnd(backdrop,()=>{if(!this.isOpen)return;if(this.preserveScrollPosition&&typeof this._saveScroll==="number"){const moviaContent=backdrop.querySelector(".movia__content");if(moviaContent){moviaContent.scrollTop=this._saveScroll}}this.onOpen?.()})}close(forceDestroy=false){if(!this.isOpen||!this.backdrop)return;this.isOpen=false;const index=moviaStack.indexOf(this);if(index!==-1){moviaStack.splice(index,1)}const backdrop=this.backdrop;if(this.preserveScrollPosition){const moviaContent=backdrop.querySelector(".movia__content");this._saveScroll=moviaContent.scrollTop}backdrop.classList.remove("movia--show");if(this._keydownHandler&&this._keydownBound){document.removeEventListener("keydown",this._keydownHandler);this._keydownBound=false}const willDestroy=forceDestroy||this.destroyOnClose;this._onTransitionEnd(backdrop,()=>{updateScrollLock();if(this.isOpen)return;if(willDestroy){if(this._childOpenHandler){backdrop.removeEventListener("click",this._childOpenHandler);this._childOpenHandler=null}backdrop.remove();this.backdrop=null;this._isMounted=false;this.footerElement=null;this._footerInitialized=false;this._pendingFooterButtons=[];this._pendingFooterContent=null;this._pendingContent=null}else{backdrop.style.visibility="hidden"}this.onClose?.()})}_forceReleaseScrollLock(){if(activeScrollLockOwner!==this)return;this._unlockScrollIfOwner();activeScrollLockOwner=null}destroy(){this._isDestroyed=true;this._forceReleaseScrollLock();if(this._parentMovia){const list=this._parentMovia._childMovias;const index=list.indexOf(this);if(index!==-1){list.splice(index,1)}this._parentMovia=null}if(this.isOpen){this.close(true)}else if(this.backdrop){this.backdrop.remove()}}_onTransitionEnd(backdrop,callback){if(!backdrop){callback?.();return}let finished=false;const finish=()=>{if(finished)return;finished=true;backdrop.removeEventListener("transitionend",onTransitionEnd);clearTimeout(timeoutId);try{callback?.()}catch(err){console.error(err)}};const onTransitionEnd=e=>{if(e.target!==backdrop)return;finish()};backdrop.addEventListener("transitionend",onTransitionEnd);const timeoutId=setTimeout(finish,350)}_getScrollbarWidth(){if(typeof this._scrollbarWidth==="number"){return this._scrollbarWidth}const div=document.createElement("div");Object.assign(div.style,{overflow:"scroll",position:"absolute",top:"-9999px",width:"100px",height:"100px"});document.body.appendChild(div);this._scrollbarWidth=div.offsetWidth-div.clientWidth;document.body.removeChild(div);return this._scrollbarWidth}}