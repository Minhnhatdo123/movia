const moviaStack=[];function getTopMovia(){return moviaStack[moviaStack.length-1]||null}export const $=document.querySelector.bind(document);export const $$=document.querySelectorAll.bind(document);export const MoviaGlobal={defaultCloseMethods:["button","overlay","escape"],defaultCssClass:[],destroyOnClose:false,autoSanitize:true,set(config={}){Object.assign(this,config)}};let moviaIdCounter=0;export class Movia{footerButton=[];onOpen=null;onClose=null;constructor(config={}){const defaultConfig={templatedId:null,content:"",closeMethods:MoviaGlobal.defaultCloseMethods.slice(),destroyOnClose:MoviaGlobal.destroyOnClose,footer:false,cssClass:MoviaGlobal.defaultCssClass.slice(),onOpen:null,onClose:null,footerButton:[]};const finalConfig=Object.assign({},defaultConfig,config);Object.assign(this,finalConfig);this.id=++moviaIdCounter;this.isOpen=false;this.backdrop=null;this.footerElement=null;this.contentElement=null;this._pendingContent=null;this._pendingFooterButtons=[];this._pendingFooterContent=null;this._footerInitialized=false;this._keydownHandler=null;this._childMovias=[]}createMovia(){if(this.backdrop)return this.backdrop;const backdrop=document.createElement("div");backdrop.className="movia-backdrop";backdrop.id=`movia-${this.id}`;const container=document.createElement("div");container.className="movia-container";if(Array.isArray(this.cssClass)&&this.cssClass.length){this.cssClass.forEach(cls=>{if(typeof cls==="string"&&cls.trim()){container.classList.add(cls)}})}if(Array.isArray(this.closeMethods)&&this.closeMethods.includes("button")){const closeBtn=this._createButton("&times;","movia-close",this.close.bind(this));container.appendChild(closeBtn)}const moviaContent=document.createElement("div");moviaContent.className="movia-content";if(this.templatedId){const template=document.getElementById(this.templatedId);if(template&&template.content){moviaContent.appendChild(template.content.cloneNode(true))}else{moviaContent.innerHTML=String(this.content??"")}}else{moviaContent.innerHTML=String(this.content??"")}this.contentElement=moviaContent;container.append(moviaContent);if(Array.isArray(this.closeMethods)&&this.closeMethods.includes("overlay")){backdrop.addEventListener("click",e=>{if(e.target===backdrop)this.close()})}if(Array.isArray(this.closeMethods)&&this.closeMethods.includes("escape")){this._keydownHandler=e=>{if(e.key==="Escape"){const top=getTopMovia();if(top===this){this.close()}}}}if(this.footer){const moviaFooter=document.createElement("div");moviaFooter.className="movia-footer";this.footerElement=moviaFooter;this.footerElement.innerHTML="";if(this._pendingFooterContent!==null){this.footerElement.innerHTML=this._pendingFooterContent;this._pendingFooterContent=null}if(!this._footerInitialized&&this.footerButton?.length){this.footerButton.forEach(btnConfig=>{const btn=this._createButton(btnConfig.label,btnConfig.classNames,btnConfig.onClick);moviaFooter.append(btn)});this._footerInitialized=true}if(Array.isArray(this._pendingFooterButtons)&&this._pendingFooterButtons?.length){this._pendingFooterButtons.forEach(cfg=>{const btn=this._createButton(cfg.label,cfg.classNames,cfg.onClick);moviaFooter.appendChild(btn)});this._pendingFooterButtons=[]}container.append(moviaFooter)}backdrop.append(container);this.backdrop=backdrop;return backdrop}updateContent(html){if(MoviaGlobal.autoSanitize){html=this.sanitizeHTML(html)}if(!this.backdrop){this._pendingContent=html;return}const contentEl=this.backdrop.querySelector(".movia-content");if(this.isOpen&&contentEl){contentEl.innerHTML=html}else{this._pendingContent=html}this.content=html}setFooterContent(html){if(MoviaGlobal.autoSanitize){html=this.sanitizeHTML(html)}if(!this.footerElement){this._pendingFooterContent=html;return}this.footerElement.innerHTML=html}sanitizeHTML(html){if(!MoviaGlobal.autoSanitize){return String(html??"")}const parser=new DOMParser;const doc=parser.parseFromString(String(html),"text/html");const dangerousTags=["script","iframe","embed","object","link","meta"];const dangerousAttrs=["onerror","onclick","onload","oninput","onchange","onmouseover"];dangerousTags.forEach(tag=>{doc.querySelectorAll(tag).forEach(el=>el.remove())});doc.querySelectorAll("*").forEach(el=>{[...el.attributes].forEach(attr=>{const name=attr.name.toLowerCase();const value=attr.value;if(name.startsWith("on")){el.removeAttribute(name);return}if(dangerousAttrs.includes(name)){el.removeAttribute(name);return}if((name==="href"||name==="src")&&value.trim().toLowerCase().startsWith("javascript:")){el.removeAttribute(name);return}})});return doc.body.innerHTML}renderLabel(input){if(input instanceof HTMLElement){return input.cloneNode(true)}if(typeof input==="function"){try{return this.renderLabel(input())}catch(err){return this._createSpan(String(err))}}if(typeof input!=="string"){return this._createSpan(String(input))}if(!/[<>]/.test(input)){return this._createSpan(input)}const span=document.createElement("span");span.innerHTML=this.sanitizeHTML(input);return span}_createSpan(text){const span=document.createElement("span");span.textContent=String(text);return span}_createButton(label,classNames="",onClick=null){const btn=document.createElement("button");btn.type="button";if(Array.isArray(classNames)){classNames.filter(Boolean).forEach(cls=>btn.classList.add(cls))}else if(typeof classNames==="string"&&classNames.trim()){classNames.split(/\s+/).forEach(cls=>btn.classList.add(cls))}if(typeof onClick==="function"){btn.addEventListener("click",e=>{onClick.call(this,e)})}if(typeof label==="string"&&/^&[a-zA-Z0-9]+;?$/.test(label)){btn.innerHTML=label}else{const rendered=this.renderLabel(label);if(rendered instanceof DocumentFragment){btn.appendChild(rendered)}else{btn.appendChild(rendered)}}return btn}addFooterButton(btnConfig={}){if(!btnConfig||typeof btnConfig!=="object")return;if(!this.footerElement){const exists=this._pendingFooterButtons.some(btn=>btn.label===btnConfig.label);if(!exists){this._pendingFooterButtons.push({label:btnConfig.label,classNames:btnConfig.classNames,onClick:btnConfig.onClick})}return}const existingButtons=Array.from(this.footerElement.children);const alreadyExists=existingButtons.some(btn=>btn.textContent.trim()===String(btnConfig.label).trim());if(!alreadyExists){const btn=this._createButton(btnConfig.label,btnConfig.classNames,btnConfig.onClick);this.footerElement.appendChild(btn)}}setupChildMovia(childMovia){if(!childMovia)return;this._childMovias.push(childMovia);if(this.isOpen&&this.backdrop){this._attachChildOpenHandler(childMovia)}}_attachChildOpenHandler(childMovia){if(!this.backdrop)return;this.backdrop.addEventListener("click",e=>{const btn=e.target.closest("[data-open-movia]");if(!btn)return;const openId=btn.dataset.openMovia??btn.getAttribute("data-open-movia");if(!openId)return;if(openId===childMovia.templatedId||openId===String(childMovia.id)){childMovia.open()}})}open(){if(this.isOpen)return;this.isOpen=true;moviaStack.push(this);const backdrop=this.backdrop||this.createMovia();if(this._childMovias.length){this._childMovias.forEach(child=>{this._attachChildOpenHandler(child)})}if(!document.body.contains(backdrop)){document.body.appendChild(backdrop)}if(this._pendingContent!==null){const contentEl=backdrop.querySelector(".movia-content");if(contentEl){contentEl.innerHTML=this._pendingContent}this._pendingContent=null}if(this._keydownHandler){document.addEventListener("keydown",this._keydownHandler)}const scrollbarWidth=this._getScrollbarWidth();document.body.classList.add("no-scroll");const prePaddingRight=document.body.style.paddingRight||"";document.body.style.paddingRight=`${(parseFloat(prePaddingRight)||0)+scrollbarWidth}px`;this._preBodyPaddingRight=prePaddingRight;backdrop.style.visibility="";backdrop.classList.add("show");requestAnimationFrame(()=>{backdrop.dispatchEvent(new CustomEvent("movia:ready"));if(typeof this.onReady==="function"){try{this.onReady()}catch(err){console.log(err)}}});this._onTransitionEnd(backdrop,()=>{if(typeof this._saveScroll==="number"){const moviaContent=backdrop.querySelector(".movia-content");if(moviaContent){moviaContent.scrollTop=this._saveScroll}}if(typeof this.onOpen==="function"){try{this.onOpen()}catch(err){console.error(err)}}})}close(forceDestroy=false){if(!this.isOpen||!this.backdrop)return;const index=moviaStack.indexOf(this);if(index!==-1){moviaStack.splice(index,1)}this.isOpen=false;const backdrop=this.backdrop;const moviaContent=backdrop.querySelector(".movia-content");this._saveScroll=moviaContent.scrollTop;if(!moviaStack.length){document.body.classList.remove("no-scroll");if(typeof this._preBodyPaddingRight!=="undefined"){document.body.style.paddingRight=this._preBodyPaddingRight;delete this._preBodyPaddingRight}document.body.style.paddingRight=""}else{const scrollbarWidth=this._getScrollbarWidth();document.body.style.paddingRight=`${scrollbarWidth}px`}backdrop.classList.remove("show");if(this._keydownHandler){document.removeEventListener("keydown",this._keydownHandler)}let willDestroy;if(this.destroyOnClose===null||typeof this.destroyOnClose==="undefined"){const moviaContainer=backdrop.querySelector(".movia-container");const hasScroll=moviaContainer.scrollHeight>moviaContainer.clientHeight;willDestroy=!hasScroll}else{willDestroy=forceDestroy||this.destroyOnClose}this._onTransitionEnd(backdrop,()=>{if(willDestroy){backdrop.remove();this.backdrop=null;this.footerElement=null;this._footerInitialized=false}else{backdrop.style.visibility="hidden"}this._pendingFooterButtons=[];this._pendingFooterContent=null;this._pendingContent=null;if(typeof this.onClose==="function"){try{this.onClose()}catch(err){console.log(err)}}})}destroy(){this.close(true)}_onTransitionEnd(backdrop,callback){if(!backdrop){callback?.();return}let finished=false;const finish=()=>{if(finished)return;finished=true;backdrop.removeEventListener("transitionend",onTransitionEnd);clearTimeout(timeoutId);try{callback?.()}catch(err){console.error(err)}};const onTransitionEnd=e=>{if(e.target!==backdrop)return;finish()};backdrop.addEventListener("transitionend",onTransitionEnd);const timeoutId=setTimeout(finish,350)}_getScrollbarWidth(){if(typeof this._scrollbarWidth==="number"){return this._scrollbarWidth}const div=document.createElement("div");Object.assign(div.style,{overflow:"scroll",position:"absolute",top:"-9999px",width:"100px",height:"100px"});document.body.appendChild(div);this._scrollbarWidth=div.offsetWidth-div.clientWidth;document.body.removeChild(div);return this._scrollbarWidth}}